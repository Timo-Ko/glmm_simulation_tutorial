{
  "hash": "0365da11a776e77aaf1c3c2d446a8a64",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: \"R code from PRACTICE sections\"\nexecute:\n  eval: false\n---\n\n\n\n\n\n\n::: {.callout-note}\nThis Notebook contains only the R code from the PRACTICE sections of the manuscript. The number of samples and repetitions for all simulations have been greatly reduced to ensure that the code runs quickly and with limited computational resources.\n:::\n\n## Simulate the data generating process\n\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code .hidden}\nsimulate <- function(n_subjects = 100, n_items = 50,\n  b_0 = 0.847, b_e = 1.350, b_a = -1.253, b_c = 2.603,\n  b_ea = 0.790, b_ec = -1.393,\n  sd_u0s = 0.5, sd_u0i = 0.5, ...){\n  require(dplyr)\n  require(faux)\n  # simulate design\n  dat <- add_random(subject = n_subjects, item = n_items) %>%\n    add_between(\"subject\", expert = c(1, 0), .prob = c(0.25, 0.75)) %>%\n    mutate(advice_present = rbinom(n(), 1, prob = 2/3)) %>%\n    mutate(advice_correct = if_else(advice_present == 1L, \n                                    rbinom(n(), 1L, prob = 0.8), 0L)) %>%\n    # add random effects\n    add_ranef(\"subject\", u0s = sd_u0s) %>%\n    add_ranef(\"item\", u0i = sd_u0i) %>%\n    # compute dependent variable\n    mutate(linpred = b_0 + u0i + u0s +\n      b_e * expert + b_a * advice_present + b_c * advice_correct +\n      b_ea * expert * advice_present + b_ec * expert * advice_correct) %>%\n    mutate(y_prob = plogis(linpred)) %>%\n    mutate(y_bin = rbinom(n = n(), size = 1, prob = y_prob))\n  dat\n}\n```\n:::\n\n\n\n\n\n\n## Specify the population parameters\n\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code .hidden}\nb_0 <- qlogis(0.7)\nb_e <- qlogis(0.9) - b_0\nb_a <- qlogis(0.4) - b_0\nb_ea <- qlogis(0.85) - b_0 - b_e - b_a\nb_c <- qlogis(0.9) - b_0 - b_a\nb_ec <- qlogis(0.95) - b_0 - b_e - b_a - b_c - b_ea\nc(b_0 = b_0, b_e = b_e, b_a = b_a, b_c = b_c, b_ea = b_ea, b_ec = b_ec)\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code .hidden}\nplogis(b_0 + b_e + b_a + b_c + b_ea + b_ec)\n```\n:::\n\n\n\n\n\n\n### Insightful descriptive statistics\n\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code .hidden}\nlibrary(tidyverse)\nset.seed(1)\ndat <- simulate(n_subjects = 500, n_items = 500,\n  sd_u0s = 0.5, sd_u0i = 0.5)\ndat %>% \n  mutate(condition = fct_cross(\n    factor(expert), factor(advice_present), factor(advice_correct))) %>%\n  mutate(condition = fct_recode(condition,\n \"student, no advice\" = \"0:0:0\", \"expert, no advice\" = \"1:0:0\", \n \"student, incorrect advice\" = \"0:1:0\", \"expert, incorrect advice\" = \"1:1:0\",\n \"student, correct advice\" = \"0:1:1\", \"expert, correct advice\" = \"1:1:1\")) %>% \n  group_by(condition) %>%\n  summarize(relative_frequency = sum(y_bin) / n())\n```\n:::\n\n\n\n\n\n\n### Insightful model based quantities\n\n\n\n\n\n\n::: {#cell-fig-margdist1 .cell}\n\n```{.r .cell-code .hidden}\n#| label: fig-margdist1\n#| fig-cap: \"Marginal distributions including means, 66% and 95% confidence intervals for all experimental conditions.\"\n\nlibrary(ggdist)\ndat %>% \n  mutate(condition = fct_cross(\n    factor(expert), factor(advice_present), factor(advice_correct))) %>%\n  mutate(condition = fct_recode(condition,\n\"student, no advice\" = \"0:0:0\", \"expert, no advice\" = \"1:0:0\", \n\"student, incorrect advice\" = \"0:1:0\", \"expert, incorrect advice\" = \"1:1:0\",\n\"student, correct advice\" = \"0:1:1\", \"expert, correct advice\" = \"1:1:1\")) %>% \n  ggplot(aes(x = y_prob, y = condition)) +\n  stat_histinterval(point_interval = \"mean_qi\", slab_color = \"gray45\",\n    breaks = \"Sturges\") +\n  scale_x_continuous(breaks = seq(0, 1, 0.1), limits = c(0, 1))\n```\n:::\n\n::: {#cell-fig-margdist2 .cell}\n\n```{.r .cell-code .hidden}\n#| label: fig-margdist2\n#| fig-cap: \"Marginal distributions including means, 66% and 95% confidence intervals for all experimental conditions while setting the standard deviation of item random intercepts to 0.01.\"\nset.seed(1)\ndat <- simulate(n_subjects = 500, n_items = 500, sd_u0i = 0.01)\ndat %>% \n  mutate(condition = fct_cross(\n    factor(expert), factor(advice_present), factor(advice_correct))) %>%\n  mutate(condition = fct_recode(condition,\n\"student, no advice\" = \"0:0:0\", \"expert, no advice\" = \"1:0:0\", \n\"student, incorrect advice\" = \"0:1:0\", \"expert, incorrect advice\" = \"1:1:0\",\n\"student, correct advice\" = \"0:1:1\", \"expert, correct advice\" = \"1:1:1\")) %>% \n  ggplot(aes(x = y_prob, y = condition)) +\n  stat_histinterval(point_interval = \"mean_qi\", slab_color = \"gray45\",\n    breaks = \"Sturges\") +\n  scale_x_continuous(breaks = seq(0, 1, 0.1), limits = c(0, 1))\n```\n:::\n\n::: {.cell .hidden}\n\n```{.r .cell-code .hidden}\n#| include: false\nset.seed(1)\ndat <- simulate(n_subjects = 500, n_items = 500, sd_u0s = 0.01)\ndat %>% \n  mutate(condition = fct_cross(\n    factor(expert), factor(advice_present), factor(advice_correct))) %>%\n  mutate(condition = fct_recode(condition,\n\"student, no advice\" = \"0:0:0\", \"expert, no advice\" = \"1:0:0\", \n\"student, incorrect advice\" = \"0:1:0\", \"expert, incorrect advice\" = \"1:1:0\",\n\"student, correct advice\" = \"0:1:1\", \"expert, correct advice\" = \"1:1:1\")) %>% \n  ggplot(aes(x = y_prob, y = condition)) +\n  stat_histinterval(point_interval = \"mean_qi\", slab_color = \"gray45\",\n    breaks = \"Sturges\") +\n  scale_x_continuous(breaks = seq(0, 1, 0.1), limits = c(0, 1))\n```\n:::\n\n::: {#cell-fig-margdist3 .cell}\n\n```{.r .cell-code .hidden}\n#| label: fig-margdist3\n#| echo: false\n#| fig-cap: \"Marginal distributions including means, 66% and 95% confidence intervals for all experimental conditions while setting the standard deviation of subject and item random intercepts to 3.\"\nset.seed(1)\ndat <- simulate(n_subjects = 500, n_items = 500, sd_u0s = 3, sd_u0i = 3)\ndat %>% \n  mutate(condition = fct_cross(\n    factor(expert), factor(advice_present), factor(advice_correct))) %>%\n  mutate(condition = fct_recode(condition,\n\"student, no advice\" = \"0:0:0\", \"expert, no advice\" = \"1:0:0\", \n\"student, incorrect advice\" = \"0:1:0\", \"expert, incorrect advice\" = \"1:1:0\",\n\"student, correct advice\" = \"0:1:1\", \"expert, correct advice\" = \"1:1:1\")) %>% \n  ggplot(aes(x = y_prob, y = condition)) +\n  stat_histinterval(point_interval = \"mean_qi\", slab_color = \"gray45\",\n    breaks = \"Sturges\") +\n  scale_x_continuous(breaks = seq(0, 1, 0.1), limits = c(0, 1))\n```\n:::\n\n\n\n\n\n\n## Estimate the statistical model\n\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code .hidden}\n#| message: false\nlibrary(tidyverse)\nlibrary(lme4)\nset.seed(1)\ndat <- simulate(n_subjects = 100, n_items = 50)\nf <- y_bin ~ 1 + expert + advice_present + advice_correct + \n  expert:advice_present + expert:advice_correct +\n  (1|subject) + (1|item)\nfit <- glmer(f, data = dat, family = \"binomial\")\nsummary(fit)\n```\n:::\n\n\n\n\n\n\n## Compute the estimate\n\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code .hidden}\ngrid1 <- data.frame(advice_present = c(1, 0), advice_correct = c(1, 0), \n  expert = c(1, 1))\ngrid1\npred <- predict(fit, newdata = grid1, type = \"response\", re.form = NA)\npred\npred[1] - pred[2]\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code .hidden}\nlibrary(marginaleffects)\nlibrary(tinytable)\ngrid2 <- expand_grid(advice_present = 0:1, \n  advice_correct = 0:1, expert = 0:1)\ngrid2\npreds <- predictions(fit, newdata = grid2, \n  type = \"response\", re.form = NA)\nprint(preds, style = \"tinytable\") %>% theme_tt(theme = \"resize\")\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code .hidden}\ncontrasts <- preds %>% \n  hypotheses(hypothesis = c(\n    \"b8 = b2\",  # (correct advice, expert) - (no advice, expert)\n    \"b2 = b6\",  # (no advice, expert) - (incorrect advice, expert) \n    \"b7 = b1\",  # (correct advice, student) - (no advice, student)\n    \"b1 = b5\"), # (no advice, student) - (incorrect advice, student)\n    equivalence = c(0, 0))\nprint(contrasts, style = \"tinytable\") %>% theme_tt(theme = \"resize\")\n```\n:::\n\n\n\n\n\n\n## Perform repeated simulations\n\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code .hidden}\nsim_and_analyse <- function(\n  formula_chr = \"y_bin ~ 1 + expert + advice_present + advice_correct + \n    expert:advice_present + expert:advice_correct + (1|subject) + (1|item)\",\n  contrasts = c(\"b8 = b2\", \"b2 = b6\", \"b7 = b1\", \"b1 = b5\"), ...){\n  require(lme4)\n  require(marginaleffects)\n  require(tidyr)\n  # simulate data\n  dat <- simulate(...)\n  # fit model\n  model <- glmer(as.formula(formula_chr), data = dat, family = \"binomial\")\n  # compute contrasts\n  contr_df <- expand_grid(advice_present = 0:1, advice_correct = 0:1,\n    expert = 0:1)\n  predictions(model, newdata = contr_df, type = \"response\", re.form = NA) %>%\n    hypotheses(hypothesis = contrasts, equivalence = c(0, 0)) %>%\n    data.frame()\n}\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code .hidden}\n#| message: false\nlibrary(future)\nplan(\"multisession\", workers = 4)\nset.seed(2)\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code .hidden}\n#| message: false\nlibrary(furrr)\nsim_result <- crossing(\n  rep = 1:5,\n  n_subjects = c(100, 150, 200, 250),\n  n_items = c(10, 30, 50, 70)\n) %>%\n  mutate(res = future_pmap(., sim_and_analyse, \n    .options = furrr_options(seed = TRUE))) %>%\n  unnest(col = res)\n```\n:::\n\n\n\n\n\n\n#### Power results\n\n\n\n\n\n\n::: {#cell-fig-finalpwr .cell}\n\n```{.r .cell-code .hidden}\n#| label: fig-finalpwr\n#| fig-cap: \"Simulation-based power estimates including 95% confidence interval of the case study for different numbers of subjects and items, based on a significance level of 0.05.\"\nlibrary(binom)\nalpha <- 0.05\npower <- sim_result %>%\n  pivot_wider(names_from = term, names_sep = \"_\", \n    values_from = estimate:p.value.equiv) %>%\n  group_by(n_subjects, n_items) %>% \n  summarise(\n    power = mean(`p.value.noninf_b1=b5` < alpha & \n        `p.value.noninf_b8=b2` < alpha & `p.value.noninf_b2=b6` < alpha & \n        `p.value.noninf_b7=b1` < alpha), \n    n_sig = sum(`p.value.noninf_b1=b5` < alpha & \n        `p.value.noninf_b8=b2` < alpha & `p.value.noninf_b2=b6` < alpha & \n        `p.value.noninf_b7=b1` < alpha),\n    n = n(),\n    ci.lwr = binom.confint(n_sig, n, method = \"wilson\")$lower,\n    ci.upr = binom.confint(n_sig, n, method = \"wilson\")$upper, \n    .groups = \"drop\")\npower %>%\n  mutate(across(c(n_subjects, n_items), factor)) %>%\n  ggplot(aes(n_subjects, n_items, fill = power)) +\n  geom_tile() +\n  geom_text(aes(label = sprintf(\"%.2f \\n [%.2f; %.2f]\", \n                                power, ci.lwr, ci.upr)), \n    color = \"white\", size = 4) +\n  scale_fill_viridis_c(limits = c(0, 1)) +\n  xlab(\"number of subjects\") + ylab(\"number of items\")\n```\n:::\n\n\n\n\n\n\n#### Precision results\n\n\n\n\n\n\n::: {#cell-fig-finalprecision .cell}\n\n```{.r .cell-code .hidden}\n#| label: fig-finalprecision\n#| fig-cap: \"Simulation-based precision estimates (expected width of confidence intervals) including 95% confidence interval of the case study for different numbers of subjects and items, based on a confidence level of 0.95.\"\nprecision <- sim_result %>%\n  pivot_wider(names_from = term, names_sep = \"_\", \n    values_from = estimate:p.value.equiv) %>%\n  group_by(n_subjects, n_items) %>%\n  mutate(width = `conf.high_b8=b2` - `conf.low_b8=b2`) %>%\n  summarise(precision = mean(width),\n    ci.lwr = t.test(width)$conf.int[1],\n    ci.upr = t.test(width)$conf.int[2], \n    .groups = \"drop\")\nprecision %>%\n  mutate(across(c(n_subjects, n_items), factor)) %>%\n  ggplot(aes(n_subjects, n_items, fill = precision)) +\n  geom_tile() +\n  geom_text(aes(label = sprintf(\"%.2f \\n [%.2f; %.2f]\", \n                                precision, ci.lwr, ci.upr)), \n    color = \"white\", size = 4) +\n  scale_fill_viridis_c(limits = c(0, 0.2), direction = -1) +\n  guides(fill = guide_colourbar(reverse = TRUE)) +\n  xlab(\"number of subjects\") + ylab(\"number of items\")\n```\n:::\n",
    "supporting": [
      "rcode_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": null,
    "postProcess": false
  }
}